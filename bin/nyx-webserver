#!/usr/bin/env bash

if [[ -z $NIX_USER_PROFILE_DIR ]]; then
    echo "error: NIX_USER_PROFILE_DIR is not defined" >&2
    exit 1
fi


okko() {
    if [ $? -eq 0 ]; then echo "OK"; else echo "KO"; fi
}

case $1 in
    -h|--help|help)
        echo "nyx-webserver [install|start|stop|status|...]" && exit 0;;
    install)
        nix-env -p $NIX_USER_PROFILE_DIR/webserver -i nyx-webserver

        mkdir -p $HOME/Library/Logs/nyx/webserver/nginx
        mkdir -p $HOME/Library/Caches/nyx/webserver/nginx

        rm -f $HOME/Library/LaunchAgents/nyx.webserver.plist
        ln -s $NYX_HOME/LaunchAgents/nyx.webserver.plist $HOME/Library/LaunchAgents
        
        launchctl unload $HOME/Library/LaunchAgents/nyx.webserver.plist 2>/dev/null
        launchctl load   $HOME/Library/LaunchAgents/nyx.webserver.plist
        ;;
    start)
        launchctl start nyx.webserver
        okko
        ;;
    stop)
        /nix/var/nix/profiles/per-user/viny/webserver/bin/nginx -c $NYX_HOME/etc/nginx/nginx.conf -s stop 2>/dev/null
        okko
        ;;
    status)
        ps -ef | grep nginx | grep -v grep
        ;;
    *) 
        export PATH=$NIX_USER_PROFILE_DIR/webserver/bin:/bin
        "$@"
        ;;
esac
