#!/usr/bin/env bash

export BORG_REPO="$HOME/Google Drive/KumoBackup"
export BORG_PASSCOMMAND="security find-generic-password -a $USER -s borg-kumobackup -w"

LAUNCHD_FILE="${HOME}/Library/LaunchAgents/nyx.kumobackup.plist"

MYPATH="$(cd $(dirname $0); pwd)/$(basename $0)"

help_msg() {
    cat << EOF
Usage:
  kumobackup [command]

Available Commands:
  backup      Create a new backup
  info        Information about repository
  install     Install launchd service
  keyfile     Export Keyfile ($HOME/Downloads/borg-kumobackup.keyfile)
  list        List backups
  passphrase  Show passphrase (must be backed up in KeePass)
  printenv    Set environment in current shell, use with eval \$(kumobackup printenv)
EOF
}

# Create passphrase
# ~> security add-generic-password -D secret -U -a $USER -s borg-kumobackup -w $(head -c 1024 /dev/urandom | base64)
#
# Set BORG_REPO et BORG_PASSCOMMAND and then create the repository
# ~> borg init --encryption=keyfile
#
# WARNING: passphrase AND key file are mandatory to decrypt backups
#  * the passphrase is stored in the macOS Keychain but must be backed up too (KeePass)
#  * keyfile can be exported by ```disaster keyfile``` to be backed up (KeePass)

do_backup() {
    borg create \
        --filter AME                \
        --list                      \
        --stats                     \
        --compression lz4           \
        --show-rc                   \
        --exclude '**/.DS_Store'    \
        ::'kumobackup-{now}'        \
                                    \
        /Users/viny/Library/mbaDB

    backup_rc=$?

    case $backup_rc in
        0) 
            /usr/bin/osascript -e 'display notification "Last backup OK" with title "KumoBackup"'
            ;;
        *) 
            /usr/bin/osascript -e 'display notification "Last backup KO" with title "KumoBackup"'
            exit $backup_rc
            ;;
    esac

    borg prune                  \
        --list                  \
        --stats                 \
        --prefix 'kumobackup-'  \
        --show-rc               \
        --keep-weekly   4       \
        --keep-monthly  2

    prune_rc=$?

    case $prune_rc in
        0) 
            /usr/bin/osascript -e 'display notification "Last prune OK" with title "KumoBackup"'
            ;;
        *) 
            /usr/bin/osascript -e 'display notification "Last prune KO" with title "KumoBackup"'
            exit $prune_rc
            ;;
    esac    

}

create_launchd_file() {
    cat <<EOF
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>Label</key><string>nyx.kumobackup</string>
    <key>WorkingDirectory</key><string>$HOME/Library/Logs/kumobackup</string>
    <key>EnvironmentVariables</key>
    <dict>
        <key>PATH</key>
        <string>/opt/local/bin:/usr/bin:/bin</string>
        <key>LANG</key>
        <string>fr_FR.UTF-8</string>
    </dict>
    <key>ProgramArguments</key>
    <array>
        <string>$MYPATH</string>
        <string>backup</string>
    </array>
    <key>StartCalendarInterval</key>
    <dict>
        <key>Hour</key>
        <integer>20</integer>
        <key>Minute</key>
        <integer>0</integer>
        <key>Weekday</key>
        <integer>5</integer>
    </dict>
    <key>StandardErrorPath</key> <string>stderr.log</string>
    <key>StandardOutPath</key>   <string>stdout.log</string>
</dict>
</plist>
EOF
}

## Main ##
case $1 in
    backup) do_backup;;
    info) borg info;;
    install)
        launchctl unload "$LAUNCHD_FILE"
        create_launchd_file > "$LAUNCHD_FILE"
        launchctl load "$LAUNCHD_FILE"
        ;;
    keyfile) borg key export $BORG_REPO $HOME/Downloads/borg-kumobackup.keyfile;;
    list) borg list;;
    passphrase) eval $BORG_PASSCOMMAND;;
    printenv)
        cat << EOF
export BORG_REPO=$BORG_REPO
export BORG_PASSCOMMAND="$BORG_PASSCOMMAND"
EOF
    ;;
    *) help_msg && exit 1;;
esac